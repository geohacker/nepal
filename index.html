<!DOCTYPE html>
<html>
<head>

	<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
	<script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.js'></script>
	<script src="libs/leaflet-hash.js"></script>
	<script src="libs/geosearch/l.control.geosearch.js"></script>
	<script src="libs/geosearch/l.geosearch.provider.google.js"></script>
	<link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.css' rel='stylesheet' />
	<link href='libs/geosearch/l.geosearch.css' rel='stylesheet' />

	<title>Nepal - Maps refreshed every 30 mins</title>

	<style>
		body { margin:0; padding:0; }
		#map { position:absolute; top:0; bottom:0; width:100%; }

		.menu-ui {
			background:#fff;
			position:absolute;
			top:10px;right:10px;
			z-index:1;
			border-radius:3px;
			width:120px;
			border:1px solid rgba(0,0,0,0.4);
		}
		.menu-ui a {
			font-size:13px;
			color:#404040;
			display:block;
			margin:0;padding:0;
			padding:10px;
			text-decoration:none;
			border-bottom:1px solid rgba(0,0,0,0.25);
			text-align:center;
		}
		.menu-ui a:first-child {
			border-radius:3px 3px 0 0;
		}
		.menu-ui a:last-child {
			border:none;
			border-radius:0 0 3px 3px;
		}
		.menu-ui a:hover {
			background:#f8f8f8;
			color:#404040;
		}
		.menu-ui a.active {
			background:#3887BE;
			color:#FFF;
		}
		.menu-ui a.active:hover {
			background:#3074a4;
		}
		.leaflet-control-geosearch {
			width: 200px;
		}
	</style>
</head>

<body>
	<nav id='menu-ui' class='menu-ui'></nav>
	<div id='map'></div>
	<script>

		L.mapbox.accessToken = 'pk.eyJ1IjoiZ2VvaGFja2VyIiwiYSI6ImFIN0hENW8ifQ.GGpH9gLyEg0PZf3NPQ7Vrg';
		var map = L.mapbox.map('map', 'mapbox.light')
			.setView([27.7052, 85.3214], 13);

		var hash = new L.Hash(map);

		new L.Control.GeoSearch({
			provider: new L.GeoSearch.Provider.Google(),
			position: 'bottomright',
			showMarker: false
		}).addTo(map);

		var layers = document.getElementById('menu-ui');
		var overlays = {
			'humanitarian': {
				'id': 'kll.ptthjjor',
				'name': 'Humanitarian',
				'slug': 'humanitarian',
				'z': 0,
				'layer': L.mapbox.tileLayer('kll.ptthjjor')
			},
			'road': {
				'id': 'planemad.5504651b',
				'name': 'Road Connectivity',
				'slug': 'road',
				'z': 3,
				'layer': L.mapbox.tileLayer('planemad.5504651b')
			},
			'shake': {
				'id': 'mulloverit.i2sdobt9',
				'name': 'Shake Map',
				'slug': 'shake',
				'z': 2,
				'layer': L.mapbox.tileLayer('mulloverit.i2sdobt9')
			},
			'isro-kathmandu': {
				'id': 'char.8p7td2vk',
				'name': 'Cartosat-2 Kathmandu 2015-04-27 Post' ,
				'slug': 'isro-kathmandu',
				'z': 2,
				'zoomTo': [[27.7104, 85.3806], 12],
				'layer': L.mapbox.tileLayer('char.8p7td2vk')
			},
			'dg-kathmandu': {
				'id': 'mapbox.satellite-kathmandu-20150425-after',
				'name': 'Digital Globe 2015-04-25 Post',
				'slug': 'dg-kathmandu',
				'z': 2,
				'layer': L.mapbox.tileLayer('mapbox.satellite-kathmandu-20150425-after')
			},
			'hiu': {
				'id': '',
				'name': 'HIU MapGive Gorkha Post',
				'slug': 'hiu',
				'z': 2,
				'zoomTo': [[28.0941, 84.7520], 11],
				'layer': L.tileLayer('http://hiu-maps.net/hot/1.0.0/gorkha-apr2015-flipped/{z}/{x}/{y}.png')
			}
		};

		for (var l in overlays) {
			addLayer(overlays[l].slug, overlays[l].name, overlays[l].z, overlays[l].zoomTo);
		}


		function addLayer(slug, name, zIndex, zoomTo) {
		    // Create a simple layer switcher that
		    // toggles layers on and off.
		    var link = document.createElement('a');
		    link.href = '#';
		    link.className = slug;
		    link.innerHTML = name;

		    link.onclick = function(e) {
		    	e.preventDefault();
		    	e.stopPropagation();
		    	switchLayer(slug, zoomTo);
		};

		layers.appendChild(link);
	}

	var link = document.createElement('a');
	link.href = 'http://kathmandulivinglabs.github.io/quake-maps/';
	link.className = ' '
	link.innerHTML = 'Printable';
	layers.appendChild(link);

	if (window.location.search) {
		var layers = window.location.search.split("=")[1].split(",");
		for (var i=0; i<layers.length; i++) {
			switchLayer(layers[i]);
			//switchLayer(window.location.search.split('=')[1]);
		}
	}

	function switchLayer(slug, zoomTo) {
		element = $('.'+slug);

		var layer = overlays[slug].layer;
		if (map.hasLayer(layer)) {
			//window.location.search = '';
			removeLayerState(slug);
			map.removeLayer(layer);
			$('.'+slug).removeClass('active');
		} else {
			map.addLayer(layer);
			if (zoomTo) {
				map.setView(zoomTo[0], zoomTo[1]);
			}
			addLayerState(slug);
			//window.location.search = 'layer='+slug;
			$('.'+slug).addClass('active');
		}
	}

	function removeLayerState(slug) {
		var currentLayers = getCurrentLayersFromURL();
		var newLayers = [];
		currentLayers.forEach(function(layer) {
			if (layer !== slug) {
				newLayers.push(layer);
			}
		});
		var layerString = newLayers.join(",");
		setLayersState(layerString);
	}

	function getCurrentLayersFromURL() {
		var currentLayers = [];
		var search = window.location.search;
		if (search !== '') {
			currentLayers = search.split("=")[1].split(",")
		}
		return currentLayers;		
	}

	function addLayerState(slug) {
		var currentLayers = getCurrentLayersFromURL();
		if (currentLayers.indexOf(slug) === -1) {
			currentLayers.push(slug);
		}
		var layerString = currentLayers.join(",");
		setLayersState(layerString);
	}

	function setLayersState(layersString) {
		console.log(layersString);
		var url;
		if (layersString === '') {
			url = window.location.hash; 
		} else {
			url = "?layers=" + layersString + window.location.hash;
		}
		window.history.replaceState(null, null, url);
	}

</script>

</body>